# Ralph Progress Log
Started: 2026-01-30
Feature: AI Auto-Update URLs
Parent Task: 27

## Codebase Patterns
- Tailwind v4 with @tailwindcss/vite plugin (no separate config file)
- Custom colors: sidebar, accent, surface defined in @theme block in index.css
- Custom fonts: font-heading (DM Sans), font-body (IBM Plex Sans)
- Component classes: .nav-link, .btn-primary, .btn-secondary defined in @layer components
- AI/magic features use violet-500 to indigo-600 gradient to differentiate from accent green
- Modal/dialog pattern: fixed overlay with backdrop blur + centered content
- Toast pattern: isLeaving state for exit animation before onHide callback
- Use useLiveQuery from dexie-react-hooks for reactive queries
- All mutations are async functions (not hooks) for easy calling from event handlers

---

## 2026-01-30 - Define URL schema and types
Thread: https://ampcode.com/threads/T-019c0f89-3bbb-77f3-9c1a-2eff164af59a
Task ID: 28
- Added `AutoUpdatePayload` interface to src/types/index.ts
- Interface includes: candidateId (required), interviewId, primary_profile, secondary_profiles, overall_hire_signal, axis_scores, axis_notes, tags
- Reuses existing `Axis` and `HireSignal` types
- **Learnings:** Axis and HireSignal types already defined - use `Partial<Record<Axis, T>>` for sparse axis data
---

## 2026-01-30 - Create URL parser/generator utilities
Thread: https://ampcode.com/threads/T-019c0f8a-3aba-7494-b0bf-faff6f22d8a7
Task ID: 29
- Created `src/utils/autoUpdateUrl.ts` with `parseAutoUpdateUrl()` and `generateAutoUpdateUrl()` functions
- URL format: `{origin}/#/apply?data={base64EncodedJSON}`
- Parser extracts data from hash query params, decodes base64, validates JSON structure
- Validates: candidateId (required), interviewId, primary_profile, secondary_profiles, overall_hire_signal, axis_scores (1-5), axis_notes, tags
- Returns null for malformed URLs, invalid base64, or failed validation
- Generator uses `window.location.origin` for SPA compatibility
- **Learnings:** 
  - Use `new URL()` then parse hash manually for hash-based routing params
  - Use `atob()`/`btoa()` for base64 encoding/decoding in browser
  - Validate axis_scores values are numbers 1-5
---

## 2026-01-30 - Update CandidateSummaryPromptModal with URL template
Thread: https://ampcode.com/threads/T-019c0f8b-e519-730f-bc00-665160a8393e
Task ID: 34
- Added auto-update URL template section to `generateSummaryPrompt()` function
- Imports `generateAutoUpdateUrl` from utils
- Template includes: format explanation, JSON payload fields, instructions, and example URL
- Example uses the actual candidate ID for valid URLs
- Lists all supported fields: primary_profile, secondary_profiles, overall_hire_signal, tags
- **Learnings:**
  - Use `as const` for literal type inference in example payloads
  - `window.location.origin` needs SSR guard (`typeof window !== 'undefined'`)
---

## 2026-01-30 - Update AIPromptModal with URL template
Thread: https://ampcode.com/threads/T-019c0f8d-2bce-70bc-ba77-fc90195bcf0b
Task ID: 33
- Added auto-update URL template section to `generatePrompt()` function in AIPromptModal.tsx
- Imports `generateAutoUpdateUrl` from utils
- Template includes: format explanation, JSON payload fields, instructions, and example URL
- Interview-specific: includes both candidateId and interviewId in payload
- Supports interview-level fields: axis_scores and axis_notes (partial updates allowed)
- Example uses actual candidate_id and interview.id for valid URLs
- **Learnings:**
  - Interview has `candidate_id` (snake_case) for accessing the parent candidate
  - For interview updates, both candidateId and interviewId are required in the payload
---

## 2026-01-30 - Add /apply route handler
Thread: https://ampcode.com/threads/T-019c0f8e-aa54-76dd-8802-2d706c884f0b
Task ID: 30
- Created `src/pages/ApplyRoute.tsx` component to handle auto-update URLs
- Added `/apply` route in `src/App.tsx`
- Parses URL using `parseAutoUpdateUrl()`, redirects to candidate detail with payload in route state
- Invalid URLs show error toast and redirect to home
- Added `variant` prop to Toast component for error styling (red icon)
- Exports `AutoUpdateRouteState` interface for CandidateDetail to consume
- **Learnings:**
  - Use `useLocation()` + `window.location.href` to get full URL including hash
  - Pass state via `navigate()` second argument: `{ state: { ... }, replace: true }`
  - Toast variant pattern: add optional `variant` prop with 'success' | 'error'
---

## 2026-01-30 - Build AutoUpdatePreviewModal component
Thread: https://ampcode.com/threads/T-019c0f90-dfc8-7343-9f79-77eb6cba06ba
Task ID: 31
- Created `src/components/AutoUpdatePreviewModal.tsx` with diff-style display
- Shows current vs proposed values for all payload fields
- DiffValue component: red strikethrough for removed, green highlight for added
- Supports both candidate-level (profiles, hire_signal, tags) and interview-level (axis_scores, axis_notes) updates
- computeChanges() builds FieldChange array from payload comparison
- Uses violet-to-indigo gradient styling consistent with other AI modals
- Props: payload, candidate, interview, profileMap, isOpen, onClose, onApply
- **Learnings:**
  - Pass profileMap from CandidateDetail for name lookups
  - Interview is optional - only used when interviewId is in payload
  - onApply is async to handle database operations
---

## 2026-01-30 - Integrate AutoUpdatePreviewModal into CandidateDetail
Thread: https://ampcode.com/threads/T-019c0f93-8b96-73fe-9dcf-aea69502e637
Task ID: 32
- Imported AutoUpdatePreviewModal, AutoUpdateRouteState, and useInterview hook
- Added state: autoUpdatePayload, isAutoUpdateOpen, showAppliedToast
- useEffect reads route state from ApplyRoute and opens modal if payload present
- Clears route state after reading to prevent re-opening on navigation
- handleApplyAutoUpdate applies candidate-level and interview-level updates:
  - Candidate: primary_profile, secondary_profiles, overall_hire_signal, tags
  - Interview: axis_scores, axis_notes (merged with existing values)
- Uses updateCandidate(id, data) and updateInterview(interviewId, candidateId, data)
- Shows success toast after applying, closes modal
- Added separate Toast for "Changes applied successfully"
- **Learnings:**
  - useInterview(id) fetches interview reactively by ID
  - updateInterview takes 3 params: (id, candidateId, data)
  - Clear route state with navigate(pathname, { replace: true, state: null })
  - Partial updates: merge with existing axis_scores/axis_notes using spread operator
---

## 2026-01-30 - Add error handling and edge cases
Thread: https://ampcode.com/threads/T-019c0f96-53d0-71df-af88-f6393a4fd82e
Task ID: 35
- Added interview-not-found validation with error toast in CandidateDetail.tsx
- New state: autoUpdateError (string|null), showAutoUpdateError (boolean)
- useEffect validates after modal opens: if interviewId is in payload but interview is undefined, show error
- Uses 100ms delay to allow useLiveQuery to complete initial query before checking
- Added handleHideAutoUpdateError callback
- Added error Toast with variant="error" for red styling
- Error flow: closes modal, clears payload, shows "Interview not found" toast
- Existing error handling verified:
  - ApplyRoute.tsx: Invalid/malformed URLs show error toast and redirect to home
  - CandidateDetail.tsx: Candidate not found returns "not found" UI
- **Learnings:**
  - useLiveQuery returns undefined for both loading AND not-found states
  - Use setTimeout to allow async query to complete before checking for "not found"
  - Toast variant="error" shows red icon instead of green checkmark
---

## 2026-01-30 - Fix URL format (BrowserRouter not HashRouter)
Thread: https://ampcode.com/threads/T-019c0f96-53d0-71df-af88-f6393a4fd82e
Task ID: 35 (additional fix)
- Fixed URL generation and parsing - app uses BrowserRouter, not HashRouter
- Changed `generateAutoUpdateUrl()` to produce `/apply?data=...` (no hash)
- Updated `parseAutoUpdateUrl()` to use `urlObj.pathname` and `urlObj.searchParams`
- Updated template text in AIPromptModal and CandidateSummaryPromptModal
- Browser tested: URL redirects to candidate detail and shows preview modal correctly
- **Learnings:**
  - Check router type (BrowserRouter vs HashRouter) when generating URLs
  - BrowserRouter uses pathname, HashRouter uses hash fragment
  - For BrowserRouter, use `urlObj.searchParams.get('data')` directly
---
